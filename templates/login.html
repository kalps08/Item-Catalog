<!DOCTYPE html>
<html>
  <head>
    <!--LOAD PRE-REQUISITES FOR GOOGLE SIGN IN -->
    <!-- these scripts will create an anonymous function that inserts a script into login page's DOM -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="//apis.google.com/js/platform.js?onload=start"> </script>
    <!-- END PRE-REQUISITES FOR GOOGLE SIGN IN -->
  </head>
  <body>
    <!-- GOOGLE PLUS SIGN IN BUTTON-->
    <div class="signinButton">
      <!-- data-scope parameter specifies what google resources (openid email profile) we want to access to
      data-redirecturi parameter sets a post message enables the one-time use code flow
      data-accesstype parameter means that our server can make requests to the google api server even if the user is not logged in
      the value of data-cookiepolicy parameter determines the scope of the URIs that can access the cookie
        we use the single-host-origin if our website only has a single host name and no subdomains
      data-callback parameter specifies a callback function, if a user clicks and grants our application
        access to their profile, this callback method is called and given the one-time use code along with an access token
      data-approvalprompt parameter set to force means that our user has to login each time we visit the login page and doesnt check if they
            are already logged in - only for debugging -->
      <span class="g-signin"
        data-scope="openid email profile"
        data-clientid="228720929904-17556lgllepn79s780nnmn595oaf9t3i.apps.googleusercontent.com"
        data-redirecturi="postmessage"
        data-accesstype="offline"
        data-cookiepolicy="single_host_origin"
        data-callback="signInCallback"
        data-approvalprompt="force">
      </span>
    </div>
     <!-- An empty div named result that we can populate with a response method just above the opening script tag -->
    <div id="result"></div>

    <script>
      // the callback method that handles the response that google sends back to the client - it sends along with a successful response,
      // a one-time code to authorize our server and an access token that the client can use to mnake API calls from within the browser as well
      function signInCallback(authResult) {
        // if the object "authResult" contains a param called "code", we know that the authorization with the google API server was successful,
        // and our one-time use code is present in the value of this parameter - code
        console.log("authresult - code check")
        console.log('{{STATE}}')
        console.log(authResult['code'])
        console.log(authResult)
        console.log(result)
        if (authResult['code']) {
          // Hide the sign-in button now that the user is authorized
          $('.signinButton').attr('style', 'display: none');
          // Send the one-time-use code to the server, if the server responds, write a 'login successful' message to the web page
          // and then redirect back to the main restaurants page
          // Use jQuery to create an Ajax call that passes the one-time code google gave the client onto the server.
          console.log("Before ajax call")
          $.ajax({
            // POST method
            type: 'POST',
            // the URL this method will call - name it /g_connect- this method is defined on the server - project.py
            // along with this method, pass the server state token as an arg to verify against the cross-site reference forgery attack.
            url: '/g_connect?state={{STATE}}',
            // setting this param to false indicates that we dont want jQuery to process the response into a string
            processData: false,
            // we specify the data that we going to send along to our server - the one-time use code
            data: authResult['code'],
            // this indicates that we are sending an arbitrary binary stream of data
            // & the charset is utf-8 indicates that it is formatted using a universal character set called Unicode.
            contentType: 'application/octet-stream; charset=utf-8',
            // When we receive a 200 or a successful response code from our server:
            //console.log("Before success in ajax")
            //console.log(result)
            success: function(result) {
                // Handle or verify the server response if necessary.
                // If the server has any additional response info to pass to the client,
                // then we can present it with this "result" variable

                if (result) {
                    // lets return a successful login message to the user
                    //console.log("Result - reponse from the server: " + result)
                    $('#result').html('Login Successful! </br>'+ result + '</br>Redirecting...')
                    // And then redirect to the main restaurant page after about 4 seconds
                   setTimeout(function() {
                    window.location.href = "/";
                  }, 4000);
                  // In the event that an error was returned by Google, report this error to the console.log
                } else if (authResult['error']) {
                    console.log('There was an error: ' + authResult['error']);
                    // In the event that no response was returned by my server to the callback function, return this error
                    // message to the result div.
                  } else {
                  //$('#result').html('Failed to make a server-side call. Check your configuration and console.');
                  $('#result').html('Login Successful! </br>'+ result + '</br>Redirecting...')
                }
              },
              error: function(result) {
                alert(result);
                // lets return a successful login message to the user
                //console.log("Result - reponse from the server: " + result)
              }

            });
            //console.log("After ajax")
          }
        }
      </script>
      <!--END GOOGLE PLUS SIGN IN BUTTON -->

      <!--FACEBOOK SIGN IN -->
        <script>
          window.fbAsyncInit = function() {
          FB.init({
            appId      : '236946233903140',
            cookie     : true,  // enable cookies to allow the server to access
                                // the session
            xfbml      : true,  // parse social plugins on this page
            version    : 'v2.2' // use version 2.2
          });
          };
          // Load the SDK asynchronously - so that the rest of the page can load without it
          (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));
          // Here we run a very simple test of the Graph API after login is
          // successful. See statusChangeCallback() for when this call is made.
          function sendTokenToServer() {
            // Hide the sign-in button now that the user is authorized
            $('.signinButton').attr('style', 'display: none');
            // Retreives short-lived access token
            var access_token = FB.getAuthResponse()['accessToken'];
            console.log(access_token)
            console.log('Welcome!  Fetching your information.... ');
            // Here shows how to use FB SDK to make API calls
            FB.api('/me', function(response) {
              console.log('Successful login for: ' + response.name);
              // Send the access token to the server via Ajax along with the state value with route /fbconnect
             $.ajax({
              type: 'POST',
              url: '/fb_connect?state={{STATE}}',
              processData: false,
              data: access_token,
              contentType: 'application/octet-stream; charset=utf-8',
              success: function(result) {
                // Handle or verify the server response if necessary.
                if (result) {
                  $('#result').html('Login Successful!</br>'+ result + '</br>Redirecting...')
                 setTimeout(function() {
                  window.location.href = "/";
                 }, 4000);

              } else {
                $('#result').html('Failed to make a server-side call. Check your configuration and console.');
                 }
              }

          });
            });
          }
        </script>
        <!-- The code here uses FB SDK to create a facebook login button, scope of access and server method -->
{#        <div class="signinButton">#}
{#          <button>#}
{#            <fb:login-button scope="public_profile,email" onlogin="sendTokenToServer();">#}
{#              <a href='javascript:sendTokenToServer()'>Login with Facebook</a>#}
{#            </fb:login-button>#}
{#          </button>#}
{#        </div>#}
        <!--END FACEBOOK SIGN IN -->
    </body>
</html>
